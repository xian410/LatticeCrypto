<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>短格基生成 - 格密码算法系统</title>
    <link
      rel="stylesheet"
      href="../../static/css/element-ui@2.13.0-theme-chalk-index.css"
    />
    <style>
      #app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .param-key {
        color: #409eff;
        font-weight: bold;
      }
      .vector-input-group {
        border: 1px solid #dcdfe6;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 10px;
        background: #fafafa;
      }
      .vector-input-header {
        font-weight: 600;
        color: #409eff;
        margin-bottom: 10px;
        font-size: 14px;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <el-header style="height: auto; padding: 10px 0">
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
          "
        >
          <img
            src="../../static/img/bupt.png"
            alt="BUPT Logo"
            style="width: 160px; height: 48px; margin-right: 20px"
          />
          <h2 style="margin: 0; text-align: center; font-size: 22px">
            短格基生成系统
          </h2>
        </div>
      </el-header>

      <el-main style="flex: 1; padding: 20px">
        <el-card
          shadow="hover"
          style="
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
          "
        >
          <div slot="header" style="text-align: center; padding: 15px">
            <h2
              style="
                margin: 0;
                color: #409eff;
                font-weight: 600;
                font-size: 20px;
              "
            >
              短格基生成系统
            </h2>
            <p style="margin: 8px 0 0 0; color: #666; font-size: 14px">
              通过输入向量组生成其垂直格上的短格基
            </p>
          </div>

          <el-row>
            <!-- 主要内容 -->
            <el-col :xs="24">
              <el-alert
                title="通过输入向量组生成其垂直格上的短格基"
                type="info"
                :closable="false"
                style="margin-bottom: 20px"
              ></el-alert>

              <!-- 生成模块 -->
              <el-card shadow="hover" style="margin-bottom: 20px">
                <div slot="header">
                  <h5 style="margin: 0; color: #409eff">短格基生成模块</h5>
                </div>
                <el-form :model="generationParams" label-width="120px">
                  <el-row :gutter="15">
                    <el-col :xs="24" :sm="12">
                      <el-form-item label="算法类型">
                        <el-select
                          v-model="generationParams.algorithm"
                          placeholder="请选择算法"
                        >
                          <el-option label="LLL算法" value="lll"></el-option>
                          <el-option label="BKZ算法" value="bkz"></el-option>
                        </el-select>
                      </el-form-item>
                    </el-col>
                    <el-col :xs="24" :sm="12">
                      <el-form-item label="维度">
                        <el-input
                          v-model="generationParams.dimension"
                          placeholder="格基矩阵维度"
                        ></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>

                  <!-- 格基矩阵输入区域 -->
                  <el-form-item label="格基矩阵">
                    <div style="margin-bottom: 10px">
                      <span style="color: #909399; font-size: 12px">
                        请输入格基矩阵，格式: [[1,2,3],[4,5,6],[7,8,9]]
                        (每行一个向量，用逗号分隔)
                      </span>
                    </div>
                    <el-input
                      v-model="generationParams.latticeMatrix"
                      type="textarea"
                      :rows="8"
                      placeholder="例如: [[1,2,3],[4,5,6],[7,8,9]]"
                      style="font-family: monospace; font-size: 13px"
                    ></el-input>
                  </el-form-item>

                  <!-- 算法参数 -->
                  <el-row :gutter="15" v-if="generationParams.algorithm">
                    <el-col
                      :xs="24"
                      :sm="8"
                      v-if="generationParams.algorithm === 'lll'"
                    >
                      <el-form-item label="LLL参数 δ">
                        <el-input
                          v-model="generationParams.delta"
                          placeholder="0.75"
                        ></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col
                      :xs="24"
                      :sm="8"
                      v-if="generationParams.algorithm === 'bkz'"
                    >
                      <el-form-item label="块大小">
                        <el-input
                          v-model="generationParams.blockSize"
                          placeholder="20"
                        ></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :xs="24" :sm="8">
                      <el-form-item label="精度">
                        <el-input
                          v-model="generationParams.precision"
                          placeholder="1e-10"
                        ></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>

                  <!-- 示例按钮 -->
                  <div style="margin-bottom: 15px">
                    <el-button
                      size="small"
                      @click="loadExample(3)"
                      type="info"
                      plain
                    >
                      加载3×3示例
                    </el-button>
                    <el-button
                      size="small"
                      @click="loadExample(4)"
                      type="info"
                      plain
                    >
                      加载4×4示例
                    </el-button>
                    <el-button
                      size="small"
                      @click="generateRandomMatrix"
                      type="warning"
                      plain
                    >
                      生成随机矩阵
                    </el-button>
                  </div>

                  <div style="text-align: center; margin-top: 20px">
                    <el-button
                      type="success"
                      @click="generateShortBasis"
                      :loading="isGenerating"
                      size="medium"
                    >
                      <i class="el-icon-cpu" style="margin-right: 6px"></i>
                      开始{{generationParams.algorithm === 'lll' ? 'LLL' :
                      'BKZ'}}约化
                    </el-button>
                    <el-button
                      type="primary"
                      @click="evaluateQuality"
                      :loading="isEvaluating"
                      size="medium"
                      style="margin-left: 10px"
                    >
                      <i
                        class="el-icon-data-analysis"
                        style="margin-right: 6px"
                      ></i>
                      质量评估
                    </el-button>
                  </div>
                </el-form>
              </el-card>

              <!-- 生成结果 -->
              <div v-if="generationResults">
                <el-card shadow="hover" style="margin-bottom: 20px">
                  <div slot="header">
                    <h5 style="margin: 0; color: #67c23a">格基约化结果</h5>
                  </div>
                  <el-row :gutter="15">
                    <el-col :xs="24" :sm="6">
                      <div
                        style="
                          text-align: center;
                          padding: 15px;
                          background: #f0f9ff;
                          border-radius: 8px;
                        "
                      >
                        <div style="color: #67c23a; font-size: 13px">
                          算法类型
                        </div>
                        <div
                          style="
                            font-size: 16px;
                            font-weight: 600;
                            margin-top: 5px;
                          "
                        >
                          {{generationResults.algorithm.toUpperCase()}}
                        </div>
                      </div>
                    </el-col>
                    <el-col :xs="24" :sm="6">
                      <div
                        style="
                          text-align: center;
                          padding: 15px;
                          background: #f0f9ff;
                          border-radius: 8px;
                        "
                      >
                        <div style="color: #67c23a; font-size: 13px">
                          执行时间
                        </div>
                        <div
                          style="
                            font-size: 16px;
                            font-weight: 600;
                            margin-top: 5px;
                          "
                        >
                          {{generationResults.executionTime}}
                        </div>
                      </div>
                    </el-col>
                    <el-col :xs="24" :sm="6">
                      <div
                        style="
                          text-align: center;
                          padding: 15px;
                          background: #f0f9ff;
                          border-radius: 8px;
                        "
                      >
                        <div style="color: #67c23a; font-size: 13px">
                          矩阵维度
                        </div>
                        <div
                          style="
                            font-size: 16px;
                            font-weight: 600;
                            margin-top: 5px;
                          "
                        >
                          {{generationResults.dimension}}
                        </div>
                      </div>
                    </el-col>
                    <el-col :xs="24" :sm="6">
                      <div
                        style="
                          text-align: center;
                          padding: 15px;
                          background: #f0f9ff;
                          border-radius: 8px;
                        "
                      >
                        <div style="color: #67c23a; font-size: 13px">
                          约化质量
                        </div>
                        <div
                          style="
                            font-size: 16px;
                            font-weight: 600;
                            margin-top: 5px;
                          "
                        >
                          {{generationResults.qualityScore}}
                        </div>
                      </div>
                    </el-col>
                  </el-row>
                </el-card>
              </div>

              <!-- 输出结果 -->
              <div v-if="detailedResults">
                <el-card shadow="hover" style="margin-bottom: 20px">
                  <div slot="header">
                    <h5 style="margin: 0; color: #409eff">约化结果</h5>
                  </div>
                  <el-row :gutter="20">
                    <el-col :xs="24" :sm="12">
                      <div style="margin-bottom: 20px">
                        <h6 style="color: #409eff; margin-bottom: 10px">
                          原始格基矩阵
                        </h6>
                        <el-input
                          v-model="detailedResults.originalBasis"
                          type="textarea"
                          :rows="8"
                          readonly
                          style="font-family: monospace; font-size: 11px"
                          placeholder="原始格基矩阵将在这里显示..."
                        ></el-input>
                      </div>
                    </el-col>
                    <el-col :xs="24" :sm="12">
                      <div style="margin-bottom: 20px">
                        <h6 style="color: #67c23a; margin-bottom: 10px">
                          约化后的格基矩阵
                        </h6>
                        <el-input
                          v-model="detailedResults.reducedBasis"
                          type="textarea"
                          :rows="8"
                          readonly
                          style="font-family: monospace; font-size: 11px"
                          placeholder="约化后的格基矩阵将在这里显示..."
                        ></el-input>
                      </div>
                    </el-col>
                  </el-row>
                </el-card>

                <!-- 质量评估结果 -->
                <div v-if="qualityResults">
                  <el-card shadow="hover">
                    <div slot="header">
                      <h5 style="margin: 0; color: #e6a23c">格基质量评估</h5>
                    </div>
                    <el-row :gutter="20">
                      <el-col :xs="24" :sm="8">
                        <div
                          style="
                            text-align: center;
                            padding: 15px;
                            background: #fff7e6;
                            border-radius: 8px;
                          "
                        >
                          <div style="color: #e6a23c; font-size: 13px">
                            正交化缺陷
                          </div>
                          <div
                            style="
                              font-size: 16px;
                              font-weight: 600;
                              margin-top: 5px;
                            "
                          >
                            {{qualityResults.orthogonalityDefect}}
                          </div>
                        </div>
                      </el-col>
                      <el-col :xs="24" :sm="8">
                        <div
                          style="
                            text-align: center;
                            padding: 15px;
                            background: #fff7e6;
                            border-radius: 8px;
                          "
                        >
                          <div style="color: #e6a23c; font-size: 13px">
                            最短向量长度
                          </div>
                          <div
                            style="
                              font-size: 16px;
                              font-weight: 600;
                              margin-top: 5px;
                            "
                          >
                            {{qualityResults.shortestVectorLength}}
                          </div>
                        </div>
                      </el-col>
                      <el-col :xs="24" :sm="8">
                        <div
                          style="
                            text-align: center;
                            padding: 15px;
                            background: #fff7e6;
                            border-radius: 8px;
                          "
                        >
                          <div style="color: #e6a23c; font-size: 13px">
                            条件数
                          </div>
                          <div
                            style="
                              font-size: 16px;
                              font-weight: 600;
                              margin-top: 5px;
                            "
                          >
                            {{qualityResults.conditionNumber}}
                          </div>
                        </div>
                      </el-col>
                    </el-row>
                  </el-card>
                </div>
              </div>
            </el-col>
          </el-row>
        </el-card>
      </el-main>

      <!-- 底部操作栏 -->
      <div
        style="
          background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
          border-top: 1px solid #e0e0e0;
          padding: 20px 0;
        "
      >
        <div
          style="display: flex; justify-content: center; align-items: center"
        >
          <button
            onclick="window.location.href='../menu.html'"
            style="
              background: rgba(12, 94, 177, 0.3);
              color: white;
              border: none;
              padding: 12px 30px;
              font-size: 16px;
              font-weight: 600;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
          >
            <span style="font-size: 14px; margin-right: 4px">←</span>
            返回菜单
          </button>
        </div>
      </div>
    </div>

    <script src="../../static/js/vue-v2.6.11.js"></script>
    <script src="../../static/js/element-ui@2.13.0-index.js"></script>
    <script src="../../static/js/jquery.js"></script>
    <script src="../../static/js/common.js"></script>
    <script>
      new Vue({
        el: "#app",
        data() {
          return {
            isGenerating: false,
            isEvaluating: false,
            generationParams: {
              algorithm: "lll",
              dimension: "",
              latticeMatrix: "",
              delta: "0.75",
              blockSize: "20",
              precision: "1e-10",
            },
            generationResults: null,
            detailedResults: null,
            qualityResults: null,
          };
        },

        methods: {
          // 加载示例矩阵
          loadExample(size) {
            this.generationParams.dimension = size.toString();
            if (size === 3) {
              this.generationParams.latticeMatrix = "[[1,2,3],[4,5,6],[7,8,9]]";
            } else if (size === 4) {
              this.generationParams.latticeMatrix =
                "[[1,2,3,4],[5,6,7,8],[9,10,11,12],[13,14,15,16]]";
            }
          },

          // 生成随机矩阵
          generateRandomMatrix() {
            const dimension = parseInt(this.generationParams.dimension) || 3;
            if (dimension < 2 || dimension > 10) {
              this.$message.warning("维度应在 2-10 之间");
              return;
            }

            let matrix = "[";
            for (let i = 0; i < dimension; i++) {
              let row = "[";
              for (let j = 0; j < dimension; j++) {
                const value = Math.floor(Math.random() * 20 - 10);
                row += value;
                if (j < dimension - 1) row += ",";
              }
              row += "]";
              matrix += row;
              if (i < dimension - 1) matrix += ",";
            }
            matrix += "]";
            this.generationParams.latticeMatrix = matrix;
          },

          // 验证矩阵格式
          validateMatrix(matrixStr) {
            try {
              const matrix = JSON.parse(matrixStr);
              if (!Array.isArray(matrix)) {
                throw new Error("不是有效的数组格式");
              }

              for (let i = 0; i < matrix.length; i++) {
                if (!Array.isArray(matrix[i])) {
                  throw new Error(`第${i + 1}行不是数组`);
                }
                if (matrix[i].length !== matrix[0].length) {
                  throw new Error("矩阵不是方阵");
                }
                for (let j = 0; j < matrix[i].length; j++) {
                  if (!Number.isInteger(matrix[i][j])) {
                    throw new Error(`第${i + 1}行第${j + 1}列不是整数`);
                  }
                }
              }

              return { valid: true, matrix };
            } catch (error) {
              return { valid: false, error: error.message };
            }
          },
          async generateShortBasis() {
            // 参数验证
            if (
              !this.generationParams.algorithm ||
              !this.generationParams.dimension ||
              !this.generationParams.latticeMatrix
            ) {
              this.$message.warning("请填写所有必要参数");
              return;
            }

            // 验证矩阵格式
            const validation = this.validateMatrix(
              this.generationParams.latticeMatrix
            );
            if (!validation.valid) {
              this.$message.error("格基矩阵格式错误: " + validation.error);
              return;
            }

            const dimension = parseInt(this.generationParams.dimension);
            if (validation.matrix.length !== dimension) {
              this.$message.error(
                `矩阵维度不匹配：应为${dimension}x${dimension}`
              );
              return;
            }

            this.isGenerating = true;

            try {
              const params = {
                algorithm: this.generationParams.algorithm,
                dimension: dimension,
                latticeMatrix: this.generationParams.latticeMatrix,
                delta: parseFloat(this.generationParams.delta) || 0.75,
                blockSize: parseInt(this.generationParams.blockSize) || 20,
                precision: parseFloat(this.generationParams.precision) || 1e-10,
              };

              let response;
              if (params.algorithm === "lll") {
                response = await fetch(
                  "http://localhost:3001/api/quantum/shortbasis/lll/reduce",
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(params),
                  }
                );
              } else {
                response = await fetch(
                  "http://localhost:3001/api/quantum/shortbasis/bkz/reduce",
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(params),
                  }
                );
              }

              const result = await response.json();

              if (result.success) {
                this.generationResults = {
                  algorithm: params.algorithm,
                  executionTime: result.data.executionTime,
                  dimension: `${dimension}x${dimension}`,
                  qualityScore: result.data.qualityScore || "待评估",
                };

                this.detailedResults = {
                  originalBasis: this.formatMatrix(validation.matrix),
                  reducedBasis:
                    result.data.reducedBasis || "约化结果将在这里显示",
                };

                this.$message.success("格基约化完成");
              } else {
                throw new Error(result.error || "服务器错误");
              }
            } catch (error) {
              console.error("格基约化失败:", error);
              this.$message.error("格基约化失败: " + error.message);
            }

            this.isGenerating = false;
          },
          // 格基质量评估
          async evaluateQuality() {
            if (!this.detailedResults || !this.detailedResults.reducedBasis) {
              this.$message.warning("请先执行格基约化");
              return;
            }

            this.isEvaluating = true;

            try {
              const params = {
                dimension: parseInt(this.generationParams.dimension),
                latticeMatrix: this.generationParams.latticeMatrix,
              };

              const response = await fetch(
                "http://localhost:3001/api/quantum/shortbasis/evaluate",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(params),
                }
              );

              const result = await response.json();

              if (result.success) {
                this.qualityResults = result.data.qualityMetrics;
                this.$message.success("质量评估完成");
              } else {
                throw new Error(result.error || "服务器错误");
              }
            } catch (error) {
              console.error("质量评估失败:", error);
              this.$message.error("质量评估失败: " + error.message);
            }

            this.isEvaluating = false;
          },

          // 格式化矩阵显示
          formatMatrix(matrix) {
            return matrix.map((row) => `[${row.join(", ")}]`).join("\n");
          },
          backToMenu() {
            window.location.href = "../menu.html";
          },
        },
      });
    </script>
  </body>
</html>
